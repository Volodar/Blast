window.__require=function o(t,e,r){function i(n,l){if(!e[n]){if(!t[n]){var c=n.split("/");if(c=c[c.length-1],!t[c]){var d="function"==typeof __require&&__require;if(!l&&d)return d(c,!0);if(s)return s(c,!0);throw new Error("Cannot find module '"+n+"'")}n=c}var h=e[n]={exports:{}};t[n][0].call(h.exports,function(o){return i(t[n][1][o]||o)},h,h.exports,o,t,e,r)}return e[n].exports}for(var s="function"==typeof __require&&__require,n=0;n<r.length;n++)i(r[n]);return i}({boosters:[function(o,t,e){"use strict";cc._RF.push(t,"601690DYSdCx4WwHR5kplia","boosters"),Object.defineProperty(e,"__esModule",{value:!0}),e.BoosterBomb=e.BoosterSwapTile=e.BoosterChooseGroup=void 0;var r=function(){function o(){}return o.prototype.action=function(o,t,e){return[o.findMatch(t,e),[]]},o}();e.BoosterChooseGroup=r;var i=function(){function o(){this.row_0=-1,this.col_0=-1,this.row_1=-1,this.col_1=-1}return o.prototype.action=function(o,t,e){if(-1===this.row_0&&-1===this.col_0)return this.row_0=t,this.col_0=e,[null,null];this.row_1=t,this.col_1=e;var r=o.model.board.grid[this.row_0][this.col_0],i=o.model.board.grid[this.row_1][this.col_1];return o.model.board.grid[this.row_0][this.col_0]=i,o.model.board.grid[this.row_1][this.col_1]=r,i.row=this.row_0,i.col=this.col_0,r.row=this.row_1,r.col=this.col_1,this.row_0=-1,this.col_0=-1,this.row_1=-1,this.col_1=-1,[[],[r,i]]},o}();e.BoosterSwapTile=i;var s=function(){function o(o){this.radius=o}return o.prototype.action=function(o,t,e){for(var r=o.model.board,i=r.rows,s=r.cols,n=Math.max(0,t-this.radius),l=Math.min(i-1,t+this.radius),c=Math.max(0,e-this.radius),d=Math.min(s-1,e+this.radius),h=[],a=n;a<=l;a++)for(var u=c;u<=d;u++){var p=r.grid[a][u];p&&h.push(p)}return 0===h.length?(console.log("BoosterBomb toRemove.length is zero"),[null,null]):[h,[]]},o}();e.BoosterBomb=s,cc._RF.pop()},{}],controller:[function(o,t,e){"use strict";cc._RF.push(t,"b15b3mkqmlHjbH8CRDrRuK1","controller"),Object.defineProperty(e,"__esModule",{value:!0}),e.GameController=void 0;var r=o("./models"),i=o("./models"),s=function(){function o(o,t){this.model=null,this.createBoard(o,t)}return o.prototype.setGoalScore=function(o){this.model.goal_score=o},o.prototype.setMoves=function(o){this.model.moves=o},o.prototype.createBoard=function(o,t){this.model=new i.Model,this.model.board=new r.Board(o,t),this.hasAnyGroup()||shuffle()},Object.defineProperty(o.prototype,"board",{get:function(){return this.model.board},enumerable:!1,configurable:!0}),o.prototype.doMove=function(){this.model.moves-=1},o.prototype.removeGroup=function(o){var t=this;this.model.score+=this.getScoreOfGroup(o);var e=[];return o.forEach(function(o){e.push(o.id),t.model.board.grid[o.row][o.col]=null}),e},o.prototype.dropTiles=function(){for(var o=[],t=this.model.board.rows,e=this.model.board.cols,r=0;r<e;r++)for(var i=t-1,s=t-1;s>=0;s--){var n=this.model.board.grid[s][r];null!==n&&(i!==s&&(this.model.board.grid[i][r]=n,n.row=i,n.col=r,this.model.board.grid[s][r]=null,o.push(n)),i--)}return o},o.prototype.findMatch=function(o,t){var e=this,r=this.model.board.grid[o][t];if(!r)return[];for(var i=r.color,s=new Set,n=[[o,t]],l=[],c=function(){var o=n.pop(),t=o[0],r=o[1],c=t*d.model.board.grid.length+r;if(s.has(c))return"continue";s.add(c),l.push(d.model.board.grid[t][r]),[[1,0],[-1,0],[0,1],[0,-1]].forEach(function(o){var s=o[0],l=o[1],c=t+s,d=r+l;e.model.board.inBounds(c,d)&&e.model.board.grid[c][d]&&e.model.board.grid[c][d].color===i&&n.push([c,d])})},d=this;n.length;)c();return l},o.prototype.createNewTiles=function(){for(var o=[],t=0;t<this.model.board.cols;t++)for(var e=0;e<this.model.board.rows;e++)if(null===this.model.board.grid[e][t]){var r=this.model.board.newTile(e,t);this.model.board.grid[e][t]=r,o.push(r)}return o},o.prototype.hasAnyGroup=function(){for(var o=0;o<this.model.board.rows;o++)for(var t=0;t<this.model.board.cols;t++){var e=this.model.board.grid[o][t];if(t+1<this.model.board.cols&&this.model.board.grid[o][t+1].color===e.color)return!0;if(o+1<this.model.board.rows&&this.model.board.grid[o+1][t].color===e.color)return!0}return!1},o.prototype.shuffle=function(){for(var o=0;o<this.model.board.rows;o++)for(var t=0;t<this.model.board.cols;t++){var e=this.model.board.grid[o][t],r=Math.floor(Math.random()*this.model.board.rows),i=Math.floor(Math.random()*this.model.board.cols),s=this.model.board.grid[r][i];this.model.board.grid[r][i]=e,this.model.board.grid[o][t]=s,this.model.board.grid[r][i].row=r,this.model.board.grid[r][i].col=i,this.model.board.grid[o][t].row=o,this.model.board.grid[o][t].col=t}if(!this.hasAnyGroup())return this.shuffle();var n=[];for(o=0;o<this.model.board.rows;o++)for(t=0;t<this.model.board.cols;t++)n.push(this.model.board.grid[o][t]);return n},o.prototype.getScoreOfGroup=function(o){var t=o.length,e=t*(t+1)/2;return console.log("Add score: ",e),e},o.prototype.isGameOver=function(){return this.model.moves<=0&&this.model.score<this.model.goal_score||!this.hasAnyGroup()&&0==this.model.shuffle_count},o.prototype.isWin=function(){return this.model.moves>0&&this.model.score>=this.model.goal_score},o}();e.GameController=s,cc._RF.pop()},{"./models":"models"}],models:[function(o,t,e){"use strict";var r;cc._RF.push(t,"242acUntY9G8rtZRUVb8y6W","models"),Object.defineProperty(e,"__esModule",{value:!0}),e.Model=e.Board=e.Color=void 0,function(o){o.red="block_red",o.green="block_green",o.blue="block_blue",o.yellow="block_yellow",o.purple="block_purpure"}(r=e.Color||(e.Color={}));var i=function(){function o(o,t){this.rows=0,this.cols=0,this._id=0,this.rows=o,this.cols=t,this.grid=Array.from({length:o},function(){return Array.from({length:t},function(){return null})});for(var e=0;e<o;e++)for(var r=0;r<t;r++)this.grid[e][r]=this.newTile(e,r)}return o.prototype.newTile=function(o,t){return{id:++this._id,color:this.getRandomColor(),row:o,col:t}},o.prototype.inBounds=function(o,t){return o>=0&&t>=0&&o<this.rows&&t<this.cols},o.prototype.getRandomColor=function(){return(o=r)[(t=Object.keys(o))[Math.floor(Math.random()*t.length)]];var o,t},o}();e.Board=i;e.Model=function(){this.moves=0,this.score=0,this.goal_score=0,this.shuffle_count=3,this.board=null,this.booster_count_swap=5,this.booster_count_bomb=5},cc._RF.pop()},{}],view_board:[function(o,t,e){"use strict";cc._RF.push(t,"34338cwVjZCJZi/b1Uc8kZv","view_board");var r,i=this&&this.__extends||(r=function(o,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,t){o.__proto__=t}||function(o,t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(o[e]=t[e])})(o,t)},function(o,t){function e(){this.constructor=o}r(o,t),o.prototype=null===t?Object.create(t):(e.prototype=t.prototype,new e)}),s=this&&this.__decorate||function(o,t,e,r){var i,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,e):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(o,t,e,r);else for(var l=o.length-1;l>=0;l--)(i=o[l])&&(n=(s<3?i(n):s>3?i(t,e,n):i(t,e))||n);return s>3&&n&&Object.defineProperty(t,e,n),n};Object.defineProperty(e,"__esModule",{value:!0});var n=cc._decorator,l=n.ccclass,c=n.property,d=o("./controller"),h=o("./boosters"),a=function(o){function t(){var t=null!==o&&o.apply(this,arguments)||this;return t.root=null,t.atlas=null,t.score_text_node=null,t.moves_text_node=null,t.tileSize=100,t.rows=9,t.cols=9,t.window_lose=null,t.window_win=null,t.button_booster_swap=null,t.button_booster_bomb=null,t.boosters_count_swap=null,t.boosters_count_bomb=null,t.moves=20,t.goal_scores=500,t.controller=null,t.tileNodes=new Map,t.lock_touches=!1,t.booster=null,t.popupFont=null,t}return i(t,o),t.prototype.onLoad=function(){this.button_booster_swap.on("click",this.chooseBoosterSwap,this),this.button_booster_bomb.on("click",this.chooseBoosterBomb,this)},t.prototype.start=function(){console.log("start:"),this.controller=new d.GameController(this.rows,this.cols),this.controller.setGoalScore(this.goal_scores),this.controller.setMoves(this.moves),this.createTiles(),this.showScore(),this.showMoves(),this.resetBooster(),this.window_lose.active=!1,this.window_win.active=!1,this.showBoostersLeft()},t.prototype.createTiles=function(){var o=this.root||this.node;o.removeAllChildren();var t=this.controller;if(t&&t.model.board)for(var e=this.controller.model.board.rows,r=this.controller.model.board.cols,i=0;i<e;i++)for(var s=0;s<r;s++){var n=t.model.board.grid[i][s];if(n){var l=this.buildTileNode(n);o.addChild(l,l.getPosition().y)}}else console.log("ViewBoard: controller or board is not ready")},t.prototype.onTileClick=function(o,t){var e=this,r=this.booster.action(this.controller,o,t),i=r[0],s=r[1];if(null!=i||null!=s){if(s.length>0)console.log("Swap"),this.syncTilesToBoard(s);else{if(i.length<=1)return void console.log("remove len <= 1. result");console.log("remove tiles"),this.highlightTiles(i),this.scheduleOnce(function(){return e.removeTiles(i)},.15),this.showScorePopupAt(this.controller.getScoreOfGroup(i),o,t)}console.log("do move"),this.controller.doMove(),this.showMoves(),this.resetBooster()}else console.log("Exit from click")},t.prototype.highlightTiles=function(o){var t=this;o.forEach(function(o){var e=t.tileNodes.get(o.id);e&&cc.tween(e).to(.1,{scale:.9}).to(.08,{scale:1}).start()})},t.prototype.removeTiles=function(o){var t=this;this.controller.removeGroup(o).forEach(function(o){var e=t.tileNodes.get(o);if(e){t.tileNodes.delete(o);try{cc.tween(e).to(.1,{opacity:0,scale:.85}).call(function(){return e.removeFromParent()}).start()}catch(r){e.removeFromParent()}}}),this.lock_touches=!0,this.scheduleOnce(function(){var o=t.controller.dropTiles();t.syncTilesToBoard(o)},.12),this.scheduleOnce(function(){var o=t.controller.createNewTiles();t.spawnNewTiles(o),t.lock_touches=!1,t.showScore(),t.checkGameFinished()},.24)},t.prototype.spawnNewTiles=function(o){var t=this;o&&0!==o.length&&o.forEach(function(o){var e=t.buildTileNode(o);t.root.addChild(e,e.getPosition().y),e.opacity=0,cc.tween(e).to(.12,{opacity:255}).start()})},t.prototype.buildTileNode=function(o){var t=this,e=new cc.Node("tile_"+o.row+"_"+o.col),r=e.addComponent(cc.Sprite),i=String(o.color),s=this.atlas.getSpriteFrame(i);s?r.spriteFrame=s:console.log("SpriteFrame not found in atlas:",i);var n=this.tileSize;e.setContentSize(n,n);var l=this.getTilePosition(o.row,o.col);return e.setPosition(l),this.tileNodes.set(o.id,e),e.on(cc.Node.EventType.TOUCH_END,function(){return t.onTileClickById(o.id)},this),e},t.prototype.onTileClickById=function(o){if(!this.lock_touches){var t=this.findTilePositionById(o);if(t){var e=t[0],r=t[1];this.onTileClick(e,r)}}},t.prototype.findTilePositionById=function(o){for(var t=this.controller.model.board,e=this.controller.model.board.rows,r=this.controller.model.board.cols,i=0;i<e;i++)for(var s=0;s<r;s++){var n=t.grid[i][s];if(n&&n.id===o)return[i,s]}return null},t.prototype.syncTilesToBoard=function(o){var t=this;this.controller,o.forEach(function(o){var e=t.tileNodes.get(o.id);if(e){var r=t.getTilePosition(o.row,o.col);Math.abs(e.x-r.x)>.5||Math.abs(e.y-r.y)>.5?cc.tween(e).to(.12,{position:r}).start():e.setPosition(r),e.zIndex=r.y}}),this.root.sortAllChildren()},t.prototype.getTilePosition=function(o,t){var e=this.controller.model.board.rows,r=this.controller.model.board.cols,i=this.tileSize,s=-r*i/2+i/2+t*i,n=-e*i/2+i/2+(e-1-o)*i;return cc.v2(s,n)},t.prototype.showScore=function(){this.score_text_node&&(this.score_text_node.string=this.controller.model.score+"/"+this.controller.model.goal_score)},t.prototype.showMoves=function(){this.moves_text_node&&(this.moves_text_node.string=""+this.controller.model.moves)},t.prototype.showScorePopupAt=function(o,t,e){var r=this.root||this.node,i=this.getTilePosition(t,e),s=new cc.Node("score_popup"),n=s.addComponent(cc.Label);n.string="+"+o,n.fontSize=50,n.lineHeight=100,n.font=this.popupFont,s.setPosition(i),s.opacity=0,r.addChild(s,99999),cc.tween(s).to(.05,{opacity:255}).by(.35,{position:cc.v2(0,this.tileSize)},{easing:"sineInOut"}).to(.2,{opacity:0}).call(function(){return s.removeFromParent()}).start()},t.prototype.checkGameFinished=function(){var o=null;if(this.controller.isGameOver()&&(o=this.window_lose),this.controller.isWin()&&(o=this.window_win),!o&&!this.controller.hasAnyGroup()){var t=this.controller.shuffle();this.controller.model.shuffle_count-=1,this.syncTilesToBoard(t)}if(o){o.active=!0;var e=cc.find("button_restart",o)||o.getChildByName("button_restart");e&&(e.off("click",this.onRestart,this),e.on("click",this.onRestart,this))}},t.prototype.onRestart=function(){var o=cc.director.getScene();o&&cc.director.loadScene(o.name)},t.prototype.showBoostersLeft=function(){this.boosters_count_swap.string=String(this.controller.model.booster_count_swap),this.boosters_count_bomb.string=String(this.controller.model.booster_count_bomb)},t.prototype.chooseBoosterSwap=function(){this.booster instanceof h.BoosterSwapTile||this.controller.model.booster_count_swap>0&&(this.booster=new h.BoosterSwapTile,this.controller.model.booster_count_swap-=1,this.showBoostersLeft())},t.prototype.chooseBoosterBomb=function(){this.booster instanceof h.BoosterBomb||this.controller.model.booster_count_bomb>0&&(this.booster=new h.BoosterBomb(1),this.controller.model.booster_count_bomb-=1,this.showBoostersLeft())},t.prototype.resetBooster=function(){this.booster instanceof h.BoosterChooseGroup||(this.booster=new h.BoosterChooseGroup)},s([c(cc.Node)],t.prototype,"root",void 0),s([c(cc.SpriteAtlas)],t.prototype,"atlas",void 0),s([c(cc.Label)],t.prototype,"score_text_node",void 0),s([c(cc.Label)],t.prototype,"moves_text_node",void 0),s([c],t.prototype,"tileSize",void 0),s([c],t.prototype,"rows",void 0),s([c],t.prototype,"cols",void 0),s([c(cc.Node)],t.prototype,"window_lose",void 0),s([c(cc.Node)],t.prototype,"window_win",void 0),s([c(cc.Node)],t.prototype,"button_booster_swap",void 0),s([c(cc.Node)],t.prototype,"button_booster_bomb",void 0),s([c(cc.Label)],t.prototype,"boosters_count_swap",void 0),s([c(cc.Label)],t.prototype,"boosters_count_bomb",void 0),s([c],t.prototype,"moves",void 0),s([c],t.prototype,"goal_scores",void 0),s([c(cc.Font)],t.prototype,"popupFont",void 0),s([l],t)}(cc.Component);e.default=a,cc._RF.pop()},{"./boosters":"boosters","./controller":"controller"}]},{},["boosters","controller","models","view_board"]);